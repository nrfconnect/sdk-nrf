name: Validate pip requirements-fixed.txt

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - 'v*-branch'
    paths:
      - 'scripts/requirements*.txt'
      - '.github/workflows/validate-pip-requirements-fixed-file.yml'


jobs:
  check-requirements:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout sources
        uses: nrfconnect/action-checkout-west-update@main
        with:
          west-update-args: '--narrow mcuboot zephyr'

      - name: Get python version
        id: pyv
        run: |
          sudo snap install --channel=v4 yq
          PYTHON_VERSION=$(yq '.python.version' ./ncs/nrf/scripts/tools-versions-linux.yml)
          echo "python_version=$PYTHON_VERSION" >> $GITHUB_OUTPUT

      - name: Setup python version
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5
        with:
          python-version: '${{ steps.pyv.outputs.python_version }}'

      - name: Setup environment
        working-directory: ncs
        run: |
          pip3 install --user -U setuptools wheel pip virtualenv virtualenvwrapper

      - name: Execute script diff action
        uses: nrfconnect/action-script-diff@v0.3
        with:
          diff_file: "ncs/nrf/scripts/requirements-fixed.txt"
          script_call: |
            set -euo pipefail

            echo "Installing uv..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.cargo/bin:$PATH"

            cd ncs
            OUT_FILE="nrf/scripts/requirements-fixed.txt"
            TMP_OUT_FILE="$(mktemp)"

            echo "Regenerating $OUT_FILE using uv..."
            uv pip compile \
              --generate-hashes \
              --output "$TMP_OUT_FILE" \
              bootloader/mcuboot/scripts/requirements.txt \
              zephyr/scripts/requirements.txt \
              nrf/scripts/requirements-west-ncs-sbom.txt \
              nrf/scripts/requirements-ci.txt \
              nrf/scripts/requirements-extra.txt \
              nrf/scripts/requirements.txt

            echo "Comparing generated file with existing $OUT_FILE..."
            diff -u "$OUT_FILE" "$TMP_OUT_FILE"
