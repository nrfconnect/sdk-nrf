name: NCS west commands

on:
  pull_request:
    branches: [main]
    paths:
      - .github/workflows/west-commands.yml
      - scripts/west_commands/**
      - scripts/requirements-west-ncs-sbom.txt
      - scripts/requirements-extra.txt

permissions:
  contents: read

jobs:
  west_commands_job:
    runs-on: ubuntu-24.04
    name: Run Python checks for west commands on patch series (PR)
    steps:
      - name: Checkout the code
        uses: nrfconnect/action-checkout-west-update@main
        with:
          path: ncs/nrf
          git-fetch-depth: 0

      - name: Cache pip
        uses: actions/cache@d4323d4df104b026a6aa633fdb11d772146be0bf
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip

      - name: Install python dependencies
        working-directory: ncs/nrf
        run: |
          pip3 install -U mypy types-colorama types-editdistance types-PyYAML
          grep -E "west==" scripts/requirements-fixed.txt | cut -f1 -d"#" | cut -d ' ' -f '1'| xargs pip3 install -U
          pip3 show -f west
      - name: Run mypy
        working-directory: ncs/nrf/scripts/west_commands
        run: |
          python3 -m mypy --config-file mypy.ini ncs_west_helpers.py pygit2_helpers.py ncs_commands.py

  run-west-cmds:
    name: Run smoke tests for ncs west commands
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-14, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Setup Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5
        with:
          python-version: '3.12'
      - name: Checkout sources
        uses: nrfconnect/action-checkout-west-update@main
        with:
          git-fetch-depth: 0
          path: nrf
      - name: Install requirements
        shell: bash
        run: |
          pip3 install -r nrf/scripts/requirements-west-ncs-sbom.txt
          pip3 install -r nrf/scripts/requirements-extra.txt
      - name: Smoke test ncs-loot & ncs-compare
        shell: bash
        run: |
          west ncs-loot -h
          west ncs-compare -h
      - name: Smoke test ncs-sbom
        # macOS is not supported by scancode-toolkit(used in ncs-sbom)
        if: ${{ matrix.os == 'ubuntu-24.04' || matrix.os == 'windows-latest' }}
        shell: bash
        run: |
          west ncs-sbom -h
