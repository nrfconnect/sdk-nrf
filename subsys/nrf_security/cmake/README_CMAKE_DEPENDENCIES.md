# nrf_security and TF-M CMake dependency overview

This document describes the intended dependency graph for the TF-M and nrf_security
CMake integration so that circular dependencies and include-order issues can be
avoided when changing code.

## Build topology

- **Zephyr app (NS image)**: When `CONFIG_NRF_SECURITY` is set, nrf_security is
  added via `add_subdirectory(nrf_security)` from `nrf/subsys/CMakeLists.txt`.
  nrf_security runs in the same CMake run as the app and builds mbedcrypto,
  mbedtls, PSA client libraries, and generates config under
  `CMAKE_BINARY_DIR/generated/...`.

- **TF-M (S image)**: Built as an ExternalProject from Zephyr's
  `zephyr/modules/trusted-firmware-m/CMakeLists.txt`. A custom command runs
  CMake in a separate directory (e.g. `build/tfm/`) with options from
  `zephyr_property_target` (TFM_CMAKE_OPTIONS, TFM_MBEDCRYPTO_PATH). The TF-M
  project includes `config_extra.cmake` (generated by the Nordic TF-M module)
  and then builds nrf_security again via `add_subdirectory(nrf_security/tfm)` for
  the crypto partition.

## Intended dependency DAG (no cycles)

- **zephyr_interface** depends on **tfm** (TF-M must build first so NS API
  headers exist). Do not add dependencies from TF-M back onto Zephyr targets
  that pull in zephyr_interface.

- **tfm** depends on **SYSCALL_LIST_H_TARGET** (Zephyr generated syscall
  headers; some platform code is shared).

- **nrf_security** libraries (mbedcrypto, mbedtls, drivers) depend on
  **zephyr_interface** via `nrf_security_add_zephyr_options()`.

- **nrf_security_utils** (when not BUILD_INSIDE_TFM) links to the kernel via
  `$<TARGET_FILE:kernel>` (with an explicit `add_dependencies`) to avoid a
  cyclic link dependency with the kernel target; see comment in
  `src/utils/nrf_security_utils.cmake`.

- **cracen_psa_driver** (when not BUILD_INSIDE_TFM) depends on
  **zephyr_generated_headers** to ensure generated headers such as
  `zephyr/offsets.h` are available before compiling CRACEN sources; see
  `src/drivers/cracen/CMakeLists.txt`.

## Single source of truth for TF-M options

All appends to `TFM_CMAKE_OPTIONS` and setting of `TFM_MBEDCRYPTO_PATH` must go
through the functions in
`nrf/modules/trusted-firmware-m/cmake/nrf_tfm_apply_options.cmake`:
- `nrf_tfm_append_cmake_options(opt1 opt2 ...)`
- `nrf_tfm_set_mbedcrypto_path(path)`

Both the Nordic TF-M module and `nrf_security/cmake/config_to_tf-m.cmake` use
these functions.

## Path setup vs external core logic

- **config_extra.cmake** (generated from `configs/config_extra.cmake.in`)
  contains only path and toolchain variables (NRF_DIR, OBERON_PSA_CORE_PATH,
  generated dirs, etc.). It is passed to the TF-M build as TFM_EXTRA_CONFIG_PATH.

- **external_core.cmake** (in `nrf/modules/trusted-firmware-m/tfm_boards/`)
  owns the "external core" and "add links only once" state. It is included by
  the TF-M build from the Nordic overlay.
