#
# Copyright (c) 2022 Nordic Semiconductor
#
# SPDX-License-Identifier: LicenseRef-Nordic-5-Clause
#

menuconfig EMDS
	bool "Emergency Data Storage [EXPERIMENTAL]"
	select EXPERIMENTAL
	depends on PARTITION_MANAGER_ENABLED
	depends on FLASH_MAP
	depends on CRC
	default n
	help
	  Enable Emergency Data Storage

if EMDS

config EMDS_SCANNING_FAILURES
	int "Maximum number of scanning failures"
	default 2
	help
	  Maximum number of allowed metadata scanning failures on partition
	  before giving up. The option should be tradeoff between
	  performance and reliability. If the value is too low, the system
	  may not take into account all the candidates, and may not select
	  the best one for recovery. If the value is too high, the system
	  may take too long to scan the partition, and may not be able to
	  recover in time. The value should be set to the number of
	  expected failures during the scanning process.

config EMDS_MAX_CANDIDATES
	int "Maximum number of snapshot candidates"
	default 3
	help
	  Maximum number of snapshot candidates to keep track within
	  the partition to select the best one for recovery.

config EMDS_FLASH_TIME_WRITE_ONE_WORD_US
	int "Time to write block size into flash/rram"
	default 107 if SOC_SERIES_NRF54LX
	default 43 if SOC_SERIES_NRF53X
	default 43 if SOC_NRF52833
	default 338 if SOC_NRF52832
	default 41
	help
	  Max time to write one block into non-volatile storage (in microseconds).
	  The block size is dependent on non-volatile storage type and is 4
	  bytes for flash and 16 bytes for RRAM. The value is dependent on the
	  chip used, and should be checked against the chip's datasheet.
	  For RRAM-based flash drivers, data is written in blocks of 16 bytes
	  over buffered writing. This value is used to calculate the time to
	  write one 16-byte block.

config EMDS_FLASH_TIME_ENTRY_OVERHEAD_US
	int "Time to schedule write of one entry"
	default 300
	help
	   Max time to prepare the write of each entry (in microseconds).

config EMDS_FLASH_TIME_BASE_OVERHEAD_US
	int "Time to schedule the store process"
	default 1000 if SETTINGS && SOC_FLASH_NRF_RRAM
	default 85000 if SETTINGS && !SOC_FLASH_NRF_PARTIAL_ERASE
	default 9000 if SETTINGS && SOC_FLASH_NRF_PARTIAL_ERASE
	default 500
	help
	   Max time to prepare the store process (in microseconds). If used
	   together with SETTINGS this value has to be at least as long as the
	   time to erase one page (ERASEPAGE). If used together with
	   SOC_FLASH_NRF_PARTIAL_ERASE this value should be
	   (SOC_FLASH_NRF_PARTIAL_ERASE_MS * 1000 * 3). This is to account for
	   worst case scenario, before starting storing entries. This value
	   is dependent on the chip used, and should be checked against the chip
	   datasheet.
	   For RRAM-based persistent memory driver, use ERASEPROTECT and disregard the SOC_FLASH_NRF_PARTIAL_ERASE_MS parameter.

module = EMDS
module-str = emergency data storage
source "${ZEPHYR_BASE}/subsys/logging/Kconfig.template.log_config"

endif # EMDS
