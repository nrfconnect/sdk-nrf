# nRF Cloud MQTT configuration
# This overlay enables nRF Cloud connectivity over MQTT/TLS
#
# Why legacy crypto is enabled:
# nRF Cloud MQTT uses `mqtt.nrfcloud.com:8883`, which presents an RSA server
# certificate chain. In our environment we therefore need the legacy mbedTLS
# crypto APIs for RSA/X.509 parsing and verification. This is enabled via
# `CONFIG_NORDIC_SECURITY_BACKEND=y` (legacy backend), which pulls in the legacy
# mbedTLS crypto support required for MQTT/TLS to work with nRF Cloud.

# Desh cloud feature
CONFIG_SAMPLE_DESH_CLOUD_MQTT=y
CONFIG_SAMPLE_DESH_NATIVE_TLS=y
CONFIG_SAMPLE_DESH_NATIVE_TLS_CREDENTIAL_BUFFER_SIZE=4096
CONFIG_SAMPLE_DESH_COMMON_WORKQ_STACK_SIZE=6144
CONFIG_SETTINGS_SHELL=y

# DECT cluster (reduced to fit into RAM)
CONFIG_DECT_CLUSTER_MAX_CHILD_ASSOCIATION_COUNT=15
CONFIG_NET_IPV6_MAX_NEIGHBORS=15

# nRF Cloud core configuration
CONFIG_NRF_CLOUD=y
CONFIG_NRF_CLOUD_MQTT=y
CONFIG_NRF_CLOUD_CONNECTION_POLL_THREAD=y
CONFIG_NRF_CLOUD_CONNECTION_POLL_THREAD_STACK_SIZE=4096
CONFIG_NRF_CLOUD_SEND_TIMEOUT=y
CONFIG_NRF_CLOUD_SEND_TIMEOUT_SEC=60
CONFIG_NRF_CLOUD_SEND_DEVICE_STATUS=y

# nRF Cloud client ID (using device UUID from modem)
CONFIG_NRF_CLOUD_CLIENT_ID_SRC_MDM_DEVICE_UUID=y
# Not using JWT from modem
#CONFIG_NRF_CLOUD_JWT_SOURCE_CUSTOM=y

# nRF Cloud credentials
CONFIG_NRF_CLOUD_PROVISION_CERTIFICATES=n
CONFIG_NRF_CLOUD_CREDENTIALS_MGMT_TLS_CRED=n

# Disable cloud features reliant on nrf91 modem
CONFIG_NRF_CLOUD_WIFI_LOCATION_ENCODE_OPT_MAC_RSSI=n
CONFIG_NRF_CLOUD_AGNSS=n
CONFIG_NRF_CLOUD_PGPS=n
CONFIG_NRF_CLOUD_PGPS_REQUEST_UPON_INIT=n
CONFIG_LOCATION_METHOD_GNSS=n
CONFIG_LOCATION_METHOD_CELLULAR=n

# Disable FOTA to conserve memory
CONFIG_NRF_CLOUD_FOTA=n
CONFIG_BOOTLOADER_MCUBOOT=n
CONFIG_IMG_MANAGER=n
CONFIG_MCUBOOT_IMG_MANAGER=n

# Modem info
CONFIG_MODEM_INFO_ADD_NETWORK=n
CONFIG_MODEM_INFO_ADD_DATE_TIME=n
CONFIG_MODEM_INFO_ADD_DEVICE=y

# Networking
CONFIG_NET_NATIVE=y
CONFIG_NET_SOCKETS_SOCKOPT_TLS=y
CONFIG_NET_SOCKETS_TLS_MAX_CONTEXTS=2
CONFIG_NET_CONTEXT_SNDTIMEO=y
CONFIG_NET_SOCKETS_CONNECT_TIMEOUT=60000

# TCP configuration
CONFIG_NET_TCP=y
CONFIG_NET_TCP_WORKQ_STACK_SIZE=2048
CONFIG_NET_TCP_INIT_RETRANSMISSION_TIMEOUT=6000
CONFIG_NET_SOCKETS_TLS_CONNECT_TIMEOUT=60000
CONFIG_NET_SOCKETS_DNS_TIMEOUT=20000
CONFIG_NET_SOCKETS_DNS_BACKOFF_INTERVAL=5000

# MQTT configuration
CONFIG_MQTT_LIB_TLS=y
CONFIG_MQTT_CLEAN_SESSION=y

# nRF Security
CONFIG_NRF_SECURITY=y
CONFIG_NORDIC_SECURITY_BACKEND=y

# MBEDTLS core
CONFIG_MBEDTLS=y
CONFIG_MBEDTLS_ENABLE_HEAP=y
CONFIG_MBEDTLS_HEAP_SIZE=35000
CONFIG_MBEDTLS_TLS_LIBRARY=y
CONFIG_MBEDTLS_SSL_PROTO_TLS1_2=y
CONFIG_MBEDTLS_X509_LIBRARY=y
CONFIG_MBEDTLS_RSA_C=y
CONFIG_MBEDTLS_SSL_SERVER_NAME_INDICATION=y
CONFIG_MBEDTLS_SSL_KEEP_PEER_CERTIFICATE=n
CONFIG_MBEDTLS_SSL_IN_CONTENT_LEN=4096
CONFIG_MBEDTLS_SSL_OUT_CONTENT_LEN=4096

# MBEDTLS AES
CONFIG_MBEDTLS_AES_C=y
CONFIG_MBEDTLS_CCM_C=y
CONFIG_MBEDTLS_GCM_C=y

# MBEDTLS ECC
CONFIG_MBEDTLS_ECP_C=y
CONFIG_PSA_WANT_ECC_SECP_R1_256=y

# Disable unneeded MBEDTLS features to save flash and RAM
CONFIG_MBEDTLS_CHACHA20_C=n
CONFIG_MBEDTLS_POLY1305_C=n
CONFIG_MBEDTLS_SHA1_C=n
CONFIG_MBEDTLS_MAC_SHA256_ENABLED=n
CONFIG_MBEDTLS_CIPHER_MODE_CBC=n
CONFIG_MBEDTLS_SSL_SRV_C=n
CONFIG_MBEDTLS_CTR_DRBG_C=n
CONFIG_MBEDTLS_DHM_C=n
CONFIG_MBEDTLS_CMAC_C=n
CONFIG_MBEDTLS_CIPHER_MODE_CTR=n
CONFIG_MBEDTLS_KEY_EXCHANGE_DHE_PSK_ENABLED=n
CONFIG_MBEDTLS_KEY_EXCHANGE_DHE_RSA_ENABLED=n
