# nRF Cloud CoAP configuration
# This overlay enables nRF Cloud connectivity over CoAP/DTLS

# Disable unused features
CONFIG_MDNS_RESOLVER=n
CONFIG_MDNS_RESPONDER=n
CONFIG_MDNS_RESPONDER_DNS_SD=n

# Desh cloud feature
CONFIG_SAMPLE_DESH_CLOUD_COAP=y
CONFIG_SAMPLE_DESH_NATIVE_TLS=y
CONFIG_SAMPLE_DESH_NATIVE_TLS_CREDENTIAL_BUFFER_SIZE=4096
CONFIG_SAMPLE_DESH_COMMON_WORKQ_STACK_SIZE=6144

# Disable LTE/modem-specific features
CONFIG_AT_HOST_LIBRARY=n
CONFIG_LTE_LINK_CONTROL=n
CONFIG_LTE_PSM_REQ=n

# nRF Cloud core configuration
CONFIG_NRF_CLOUD=y
CONFIG_NRF_CLOUD_MQTT=n
CONFIG_NRF_CLOUD_COAP=y
CONFIG_NRF_CLOUD_COAP_DOWNLOADS=n
CONFIG_NRF_CLOUD_SEND_DEVICE_STATUS=y
CONFIG_NRF_CLOUD_SEND_DEVICE_STATUS_CONN_INF=y
CONFIG_NRF_CLOUD_DEVICE_STATUS_ENCODE_VOLTAGE=y
CONFIG_NRF_CLOUD_SEND_SERVICE_INFO_FOTA=n
CONFIG_NRF_CLOUD_ALERT=y
CONFIG_NRF_CLOUD_LOCATION=n

# nRF Cloud client ID (using device UUID from modem)
CONFIG_NRF_CLOUD_CLIENT_ID_SRC_MDM_DEVICE_UUID=y
# Not using JWT from modem
CONFIG_NRF_CLOUD_JWT_SOURCE_CUSTOM=y

# nRF Cloud credentials
CONFIG_NRF_CLOUD_PROVISION_CERTIFICATES=n
CONFIG_NRF_CLOUD_CREDENTIALS_MGMT_TLS_CRED=n
CONFIG_TLS_CREDENTIALS_BACKEND_PROTECTED_STORAGE=y

# Disable cloud features reliant on nrf91 modem
CONFIG_NRF_CLOUD_WIFI_LOCATION_ENCODE_OPT_MAC_RSSI=n
CONFIG_NRF_CLOUD_AGNSS=n
CONFIG_NRF_CLOUD_PGPS=n
CONFIG_NRF_CLOUD_PGPS_REQUEST_UPON_INIT=n
CONFIG_LOCATION_METHOD_GNSS=n
CONFIG_LOCATION_METHOD_CELLULAR=n

# Disable FOTA to conserve memory
CONFIG_NRF_CLOUD_FOTA=n
CONFIG_BOOTLOADER_MCUBOOT=n
CONFIG_IMG_MANAGER=n
CONFIG_MCUBOOT_IMG_MANAGER=n

# Modem info for shadow
CONFIG_MODEM_INFO=y
CONFIG_MODEM_INFO_ADD_NETWORK=n
CONFIG_MODEM_INFO_ADD_DEVICE=y
CONFIG_MODEM_INFO_ADD_DATE_TIME=n
CONFIG_MODEM_INFO_ADD_SIM=n
CONFIG_MODEM_INFO_ADD_SIM_ICCID=n
CONFIG_MODEM_INFO_ADD_SIM_IMSI=n

# Date/time configuration (NTP only)
CONFIG_DATE_TIME=y
CONFIG_DATE_TIME_NTP=y
CONFIG_DATE_TIME_THREAD_STACK_SIZE=4096
CONFIG_DATE_TIME_MODEM=n
CONFIG_DATE_TIME_AUTO_UPDATE=n
CONFIG_DATE_TIME_RETRY_COUNT=5
CONFIG_DATE_TIME_RETRY_INTERVAL_SECONDS=20

# Networking
CONFIG_NET_NATIVE=y
CONFIG_NET_IPV4=n
CONFIG_NET_TCP=n
CONFIG_NET_SOCKETS_SOCKOPT_TLS=y
CONFIG_NET_SOCKETS_TLS_MAX_CONTEXTS=1
CONFIG_NET_SOCKETS_ENABLE_DTLS=y
CONFIG_NET_SOCKETS_CONNECT_TIMEOUT=60000
CONFIG_NET_CONTEXT_SNDTIMEO=y

# MQTT (disabled for CoAP)
CONFIG_MQTT_LIB_TLS=n

# nRF Security
CONFIG_NRF_SECURITY=y
CONFIG_NORDIC_SECURITY_BACKEND=n

# TF-M crypto configuration
CONFIG_TFM_PROFILE_TYPE_NOT_SET=y
CONFIG_TFM_SFN=y
# Reduce the TFM SRAM partition. It's 0x16000 by default for the nRF91 when TFM profile is not
# set, but that much does not seem to be needed.
CONFIG_PM_PARTITION_SIZE_TFM_SRAM=0xe000

# Reduce the TFM flash partition. It's 0x40000 by default which is almost double of what is
# actually needed.
CONFIG_PM_PARTITION_SIZE_TFM=0x28000

# MBEDTLS core
CONFIG_MBEDTLS=y
CONFIG_MBEDTLS_PSA_CRYPTO_C=y
CONFIG_MBEDTLS_ENABLE_HEAP=y
CONFIG_MBEDTLS_HEAP_SIZE=20480
CONFIG_MBEDTLS_X509_LIBRARY=y
CONFIG_MBEDTLS_PEM_PARSE_C=y
CONFIG_MBEDTLS_PSA_KEY_SLOT_COUNT=10

# MBEDTLS DTLS configuration
CONFIG_MBEDTLS_DTLS=y
CONFIG_MBEDTLS_SSL_CLI_C=y
CONFIG_MBEDTLS_TLS_LIBRARY=y
CONFIG_MBEDTLS_TLS_VERSION_1_2=y
CONFIG_MBEDTLS_SSL_COOKIE_C=y
CONFIG_MBEDTLS_SSL_DTLS_HELLO_VERIFY=y
CONFIG_MBEDTLS_SSL_DTLS_CONNECTION_ID=y
CONFIG_MBEDTLS_SSL_SERVER_NAME_INDICATION=y
CONFIG_MBEDTLS_SSL_KEEP_PEER_CERTIFICATE=n
CONFIG_MBEDTLS_SSL_IN_CONTENT_LEN=1024
CONFIG_MBEDTLS_SSL_OUT_CONTENT_LEN=1024
# nRF Cloud CoAP server requires session tickets
CONFIG_MBEDTLS_SSL_SESSION_TICKETS=y

# PSA crypto algorithms
CONFIG_PSA_WANT_ECC_SECP_R1_256=y
CONFIG_PSA_WANT_KEY_TYPE_ECC_KEY_PAIR_EXPORT=y
CONFIG_PSA_WANT_KEY_TYPE_ECC_KEY_PAIR_GENERATE=y
CONFIG_PSA_WANT_ALG_ECDH=y
CONFIG_PSA_WANT_ALG_ECDSA=y
CONFIG_PSA_WANT_ALG_SHA_256=y
# nRF Cloud CoAP server requires JPAKE
CONFIG_PSA_WANT_ALG_JPAKE=y

# CoAP client
CONFIG_COAP_CLIENT_BLOCK_SIZE=1024
CONFIG_COAP_CLIENT_STACK_SIZE=4096
CONFIG_COAP_CLIENT_THREAD_PRIORITY=0
CONFIG_COAP_EXTENDED_OPTIONS_LEN_VALUE=40

CONFIG_NET_SOCKETS_TLS_SET_MAX_FRAGMENT_LENGTH=y
CONFIG_NET_SOCKETS_OFFLOAD_PRIORITY=40

# Memory optimizations (required due to increased RAM usage with crypto)
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=1536
CONFIG_NET_SOCKETS_SERVICE_STACK_SIZE=1024
CONFIG_HEAP_MEM_POOL_SIZE=3072
CONFIG_MAIN_STACK_SIZE=2048
CONFIG_SHELL_STACK_SIZE=5120
CONFIG_LOG_BUFFER_SIZE=1536
CONFIG_SHELL_CMD_BUFF_SIZE=3072
